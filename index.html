<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Haro Strait Cable + Pintail Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; padding:0; background:#eef; font-family: Arial; }
#map { height: 95vh; width: 100%; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// --- Initialize Map ---
var map = L.map('map').setView([48.558, -123.174], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

// --- Load Spectrogram Index ---
let spectrogramIndex = [];
fetch("spectrogram_index.txt").then(r=>r.text()).then(t=>{
    spectrogramIndex = t.trim().split("\n").map(line=>{
        let m = line.match(/_(\d+)m\.png$/);
        let dist = m ? parseFloat(m[1]) : 0;
        return {file: line.replace(/\\/g,'/'), dist: dist};
    }).sort((a,b)=>a.dist-b.dist);
});

// --- Create Cable Path with Loops ---
function createCableCoords(){
    const dx = 3.19;
    const total_length = 1920;
    const loop_starts = [118, 147, 271, 400, 466, 510, 630, 1300, 1800];
    const loop_lengths = [30, 60, 60, 30, 30, 30, 30, 60, 60];

    let x=[0], y=[0];
    let current_dist = 0;
    let main_y = 0;
    let loop_dir = 1;

    for(let i=0;i<loop_starts.length;i++){
        let next_loop_start = loop_starts[i];
        let L = loop_lengths[i];

        while(current_dist+dx < next_loop_start){
            current_dist += dx;
            x.push(current_dist);
            y.push(main_y);
        }

        // loop as circular bend
        let r = L/(2*Math.PI);
        let n = Math.floor(L/dx);
        for(let j=0;j<n;j++){
            let theta = 2*Math.PI*j/n;
            x.push(current_dist + r*Math.cos(theta));
            y.push(main_y + loop_dir*r*Math.sin(theta));
        }

        current_dist += L;
        loop_dir *= -1;
    }

    // remainder straight cable
    while(current_dist+dx <= total_length){
        current_dist += dx;
        x.push(current_dist);
        y.push(main_y);
    }

    // flip x to match Python code
    let coords = x.map((val,i)=>[48.558 + y[i]*0.00005, -123.174 + (total_length - val)*0.00005]);
    return coords;
}

// --- Draw Cable ---
let cableCoords = createCableCoords();
let cableLine = L.polyline(cableCoords,{color:'blue'}).addTo(map);

cableCoords.forEach((c,idx)=>{
    L.circleMarker(c,{radius:3,color:'blue'})
      .addTo(map)
      .bindPopup('Cable Point '+idx)
      .on('click', ()=>{
          if(spectrogramIndex.length>0){
              const nearest = spectrogramIndex[Math.min(idx,spectrogramIndex.length-1)];
              window.open('images/'+nearest.file,'_blank');
          }
      });
});

// --- Load Pintail Track from HTML ---
async function loadPintailTrack(){
    const res = await fetch('pintail_boat_track.html');
    const txt = await res.text();
    const match = txt.match(/var\s+trackCoords\s*=\s*(\[[^\]]*\])/);
    if(match){
        const trackCoords = JSON.parse(match[1].replace(/'/g,'"'));
        const boatLine = L.polyline(trackCoords,{color:'red', dashArray:'5,5'}).addTo(map);
        trackCoords.forEach((c,idx)=>{
            L.circleMarker(c,{radius:3,color:'red'})
              .addTo(map)
              .bindPopup('Pintail Track '+idx);
        });
    }
}

// --- Fit map bounds ---
map.fitBounds(cableLine.getBounds());
loadPintailTrack();

</script>

</body>
</html>
