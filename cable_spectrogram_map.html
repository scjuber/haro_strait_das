<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pintail Cable Spectrogram Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f4f4f4; }
  #map { height: 70vh; width: 100%; }
  #spectrogram { display:block; margin:15px auto; max-height:25vh; border:2px solid #ccc; border-radius:8px; }
  #spec-title { text-align:center; margin-bottom:15px; font-weight:bold; }
  .header { text-align:center; margin:20px; }
  iframe { display:block; width:100%; height:400px; border:none; margin-top:20px; }
</style>
</head>
<body>

<div class="header">
  <h1>Pintail Cable Spectrogram Viewer</h1>
  <p>Click along the cable to view spectrograms</p>
</div>

<div id="map"></div>
<img id="spectrogram" src="" alt="Click on cable to see spectrogram" />
<div id="spec-title"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Parameters from your Python version ---
const dx = 3.19;  // meters per channel
const totalLength = 1920;  // meters
const loopStarts = [118,147,271,400,466,510,630,1300,1800];
const loopLengths = [30,60,60,30,30,30,30,60,60];

// --- Initialize map ---
const map = L.map('map').setView([48.5559, -123.179], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18}).addTo(map);

// --- Cable coordinates (from you) ---
const cable = [
  [48.558194, -123.173432], // start
  [48.556614, -123.177670],
  [48.557296, -123.181350], // bend
  [48.555251, -123.181608],
  [48.547978, -123.183517]  // end
];
const cableLine = L.polyline(cable, {color:'blue', weight:4}).addTo(map);
map.fitBounds(cableLine.getBounds());

// --- Load spectrogram list ---
let spectrograms = [];
fetch('spectrogram_index.txt')
  .then(resp => resp.text())
  .then(text => {
    spectrograms = text.split(/\r?\n/).filter(line => line.trim() !== '');
  });

// --- Handle clicks along cable ---
cableLine.on('click', function(e) {
  if (spectrograms.length === 0) return;
  // Find nearest point along cable
  let nearest = cable[0];
  let minDist = Infinity;
  let index = 0;

  for (let i = 0; i < cable.length; i++) {
    const dist = map.distance(e.latlng, cable[i]);
    if (dist < minDist) {
      minDist = dist;
      nearest = cable[i];
      index = i;
    }
  }

  const img = spectrograms[index % spectrograms.length];
  document.getElementById('spectrogram').src = img;
  document.getElementById('spec-title').textContent = `Segment ${index + 1} â€” ${img}`;
});

// --- Overlay Pintail boat track ---
fetch('pintail_boat_track.html')
  .then(resp => resp.text())
  .then(html => {
    const matches = html.match(/\[\s*[\d\.\-]+,\s*[\d\.\-]+\s*\]/g);
    if (matches) {
      const coords = matches.map(s => s.replace(/\[|\]/g, '').split(',').map(Number));
      L.polyline(coords, {color:'green', weight:3, opacity:0.6}).addTo(map);
    }
  });

// --- Show waypoints below ---
const iframe = document.createElement('iframe');
iframe.src = 'pintail_waypoints_track.html';
document.body.appendChild(iframe);
</script>

</body>
</html>
