<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haro Strait Cable Map with Spectrograms</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#f6f7fb; }
  .header { text-align:center; padding:18px 12px; }
  #map { height: 68vh; width:100%; }
  #spec-box { max-width:1000px; margin:12px auto; text-align:center; }
  #spec-img { max-height:26vh; max-width:100%; border:2px solid #ccc; border-radius:6px; }
  #spec-title { margin-top:8px; font-weight:600; }
  iframe { width:100%; height:380px; border:0; margin-top:14px; }
</style>
</head>
<body>

<div class="header">
  <h2>Spectrogram Viewer</h2>
  <div>Click a channel marker along the cable to view its spectrogram</div>
</div>

<div id="map"></div>

<div id="spec-box">
  <img id="spec-img" src="" alt="Click a channel to show spectrogram">
  <div id="spec-title"></div>
</div>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ---------- CONFIG ----------
const dx = 3.19;                    // channel spacing (m)
const total_length = 1920;          // total cable length (m)
const loopStarts = [118,147,271,400,466,510,630,1300,1800];
const loopLengths = [30,60,60,30,30,30,30,60,60];

// GPS anchors
const gps_start = [48.558194, -123.173432];
const gps_bend  = [48.557296, -123.181350];
const gps_end   = [48.547978, -123.183517];

// ---------- helper functions ----------
function linspace(a,b,n){
  if(n<=1) return [a];
  const out = [];
  for(let i=0;i<n;i++) out.push(a + (b-a)*(i/(n-1)));
  return out;
}
function deg2rad(d){ return d*Math.PI/180; }

const lat0 = gps_start[0];
const metersPerDegLat = 111320;
const metersPerDegLon = 111320 * Math.cos(deg2rad(lat0));

function latlonToMetersDelta(lat1,lon1,lat2,lon2){
  const dy = (lat2 - lat1) * metersPerDegLat;
  const dx = (lon2 - lon1) * metersPerDegLon;
  return [dx, dy];
}
function metersDeltaToLatLon(latRef, lonRef, dx, dy){
  const lat = latRef + dy / metersPerDegLat;
  const lon = lonRef + dx / metersPerDegLon;
  return [lat, lon];
}

// ---------- Build synthetic cable model ----------
let xs = [0], ys = [0];
let current_dist = 0;
let main_y = 0;
let loop_dir = 1;

for(let idx=0; idx<loopStarts.length; idx++){
  const nextStart = loopStarts[idx];
  const L = loopLengths[idx];

  while(current_dist + dx < nextStart){
    current_dist += dx;
    xs.push(current_dist);
    ys.push(main_y);
  }

  const r = L / (2 * Math.PI);
  const nPts = Math.max(8, Math.round(L / dx));
  const thetas = linspace(0, 2*Math.PI, nPts);
  for(const th of thetas){
    xs.push(current_dist + r * Math.cos(th));
    ys.push(main_y + loop_dir * r * Math.sin(th));
  }
  current_dist += L;
  loop_dir *= -1;
}

// finish straight section
while(current_dist + dx <= total_length){
  current_dist += dx;
  xs.push(current_dist);
  ys.push(main_y);
}

// reverse so channels increase from right to left
xs = xs.map(v => total_length - v);
xs.reverse();
ys.reverse();

// recompute channel distances (0 = channel 0, 3.19 m each)
const cumDist = xs.map((v,i)=>i*dx);

// ---------- Map model to lat/lon using start, bend, and end ----------
const seg1_len = 600;           // meters to bend
const seg2_len = total_length - seg1_len;

const [dx1, dy1] = latlonToMetersDelta(gps_start[0], gps_start[1], gps_bend[0], gps_bend[1]);
const [dx2, dy2] = latlonToMetersDelta(gps_bend[0], gps_bend[1], gps_end[0], gps_end[1]);
const len1 = Math.hypot(dx1, dy1);
const len2 = Math.hypot(dx2, dy2);
const ux1 = [dx1/len1, dy1/len1];
const ux2 = [dx2/len2, dy2/len2];

const cableLatLon = xs.map(xm => {
  let latRef, lonRef, ux, segLen;
  let x_in_seg;
  if (xm <= seg1_len) {
    latRef = gps_start[0]; lonRef = gps_start[1];
    ux = ux1; segLen = seg1_len; x_in_seg = xm;
  } else {
    latRef = gps_bend[0]; lonRef = gps_bend[1];
    ux = ux2; segLen = seg2_len; x_in_seg = xm - seg1_len;
  }
  const east_m = ux[0] * x_in_seg;
  const north_m = ux[1] * x_in_seg;
  return metersDeltaToLatLon(latRef, lonRef, east_m, north_m);
});

// ---------- Build map ----------
const map = L.map('map').setView(gps_start, 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);

const cableLine = L.polyline(cableLatLon, {color:'blue', weight:3}).addTo(map);
map.fitBounds(cableLine.getBounds());

// ---------- Place channel markers & link spectrograms ----------
let channelMarkers = [];
fetch('spectrogram_index.txt')
  .then(r => r.text())
  .then(t => {
    const spectrogramList = t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);

    for(let i=0;i<cableLatLon.length;i++){
      const latlng = cableLatLon[i];
      const color = (i === 25) ? 'red' : 'blue';
      const m = L.circleMarker(latlng, {radius:3, color, fill:true, fillOpacity:0.9}).addTo(map);

      // Pick spectrogram by proportional index
      const idx = Math.min(Math.round((i / (cableLatLon.length-1)) * (spectrogramList.length-1)), spectrogramList.length-1);
      const chosen = spectrogramList[idx];

      m.on('click', () => {
        const img = document.getElementById('spec-img');
        img.src = chosen;
        const title = document.getElementById('spec-title');
        title.textContent = `Channel ${i} â€” ${(cumDist[i]).toFixed(2)} m`;
      });

      channelMarkers.push(m);
    }
  });

// ---------- Overlay Pintail boat track ----------
fetch('pintail_boat_track.html')
  .then(r => r.text())
  .then(txt => {
    const matches = txt.match(/\[\s*-?\d+\.\d+,\s*-?\d+\.\d+\s*\]/g);
    if(matches && matches.length){
      const coords = matches.map(s => s.replace(/\[|\]/g,'').split(',').map(Number));
      L.polyline(coords, {color:'green', weight:3, opacity:0.7}).addTo(map);
    }
  });

// ---------- Embed waypoints HTML ----------
const iframe = document.createElement('iframe');
iframe.src = 'pintail_waypoints_track.html';
iframe.style.width = '100%';
iframe.style.height = '360px';
iframe.style.border = 'none';
iframe.style.marginTop = '12px';
document.body.appendChild(iframe);
</script>
</body>
</html>
