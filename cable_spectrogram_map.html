<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pintail Cable Spectrogram Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f2f2f2; }
  #map { height: 70vh; width: 100%; margin-bottom: 10px; }
  #spectrogram { display: block; margin: auto; max-height: 25vh; border: 2px solid #ccc; border-radius: 8px; }
  #spec-title { text-align:center; margin:10px; font-weight:bold; }
  .header { text-align:center; margin: 20px; }
  iframe { display:block; width:100%; height:400px; border:none; margin-top:20px; }
</style>
</head>
<body>

<div class="header">
  <h1>Pintail Cable Spectrogram Viewer</h1>
  <p>Click along the cable to view spectrograms</p>
</div>

<div id="map"></div>
<img id="spectrogram" src="" alt="Click on cable to see spectrogram" />
<div id="spec-title"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([48.556, -123.179], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: ''
}).addTo(map);

// --- Load spectrogram paths ---
let spectrograms = [];
fetch('spectrogram_index.txt')
  .then(resp => resp.text())
  .then(text => {
    spectrograms = text.split(/\r?\n/).filter(line => line.trim() !== '');
  });

// --- Cable coordinates ---
const cable = [
  [48.558194, -123.173432],
  [48.556614, -123.177670],
  [48.557296, -123.181350], // bend
  [48.555251, -123.181608],
  [48.547978, -123.183517]
];
const cableLine = L.polyline(cable, {color:'blue', weight:4}).addTo(map);
map.fitBounds(cableLine.getBounds());

// --- Click on cable to show nearest spectrogram ---
cableLine.on('click', function(e) {
  if (spectrograms.length === 0) return;

  let nearestIndex = 0;
  let minDist = Infinity;
  cable.forEach((latlng, i) => {
    const d = map.distance(latlng, e.latlng);
    if (d < minDist) {
      minDist = d;
      nearestIndex = i;
    }
  });

  const imgPath = spectrograms[nearestIndex % spectrograms.length];
  document.getElementById('spectrogram').src = imgPath;
  document.getElementById('spec-title').textContent = `Channel ${nearestIndex} â€” ${imgPath}`;
});

// --- Overlay Pintail boat track ---
fetch('pintail_boat_track.html')
  .then(resp => resp.text())
  .then(html => {
    const matches = html.match(/\[\s*[\d\.\-]+,\s*[\d\.\-]+\s*\]/g);
    if (matches) {
      const coords = matches.map(s => s.replace(/\[|\]/g, '').split(',').map(Number));
      L.polyline(coords, {color:'green', weight:3}).addTo(map);
    }
  });

// --- Load Pintail waypoints below the map ---
const iframe = document.createElement('iframe');
iframe.src = 'pintail_waypoints_track.html';
document.body.appendChild(iframe);
</script>

</body>
</html>
