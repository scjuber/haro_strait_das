<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pintail Cable Spectrogram Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; }
  #map { height: 70vh; width: 100%; margin-bottom: 20px; }
  #spectrogram { display: block; margin: auto; max-height: 30vh; border: 1px solid #ccc; }
  .header { text-align:center; margin: 20px; }
</style>
</head>
<body>

<div class="header">
  <h1>Pintail Cable Map with Spectrograms</h1>
  <p>Click along the cable to view spectrograms</p>
</div>

<div id="map"></div>
<img id="spectrogram" src="" alt="Click on cable to see spectrogram" />
<div id="spec-title" style="text-align:center; margin:10px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([47.6, -122.3], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- Load spectrogram paths from spectrogram_index.txt ---
var spectrograms = [];
fetch('spectrogram_index.txt')
  .then(resp => resp.text())
  .then(text => {
    spectrograms = text.split(/\r?\n/).filter(line => line.trim() !== '');
  });

// --- Cable layout with gentle bend at ~600m ---
var cable = [
  [47.6000, -122.3000],
  [47.6002, -122.2998],
  [47.6005, -122.2995], // bend
  [47.6010, -122.2990],
  [47.6015, -122.2985]
];
var cableLine = L.polyline(cable, {color:'blue', weight:3}).addTo(map);
map.fitBounds(cableLine.getBounds());

// --- Click on cable to view spectrogram ---
cableLine.on('click', function(e){
  if(spectrograms.length === 0) return;
  var nearestIndex = 0;
  var minDist = Infinity;
  cable.forEach(function(latlng, i){
    var d = map.distance(latlng, e.latlng);
    if(d < minDist){ minDist=d; nearestIndex=i; }
  });
  document.getElementById('spectrogram').src = spectrograms[nearestIndex % spectrograms.length];
  document.getElementById('spec-title').textContent = `Channel ${nearestIndex}`;
});

// --- Load Pintail boat track ---
fetch('pintail_boat_track.html')
  .then(resp => resp.text())
  .then(html => {
    var matches = html.match(/\[\s*[\d\.\-]+,\s*[\d\.\-]+\s*\]/g);
    if(matches){
      var coords = matches.map(s=>s.replace(/\[|\]/g,'').split(',').map(Number));
      L.polyline(coords, {color:'green', weight:3}).addTo(map);
    }
  });

// --- Load waypoints as iframe overlay ---
var waypointsLayer = L.layerGroup().addTo(map);
var iframe = L.DomUtil.create('iframe','waypointsFrame');
iframe.src = 'pintail_waypoints_track.html';
iframe.style.width = '100%';
iframe.style.height = '400px';
iframe.style.border = 'none';
document.body.appendChild(iframe);

</script>
</body>
</html>
