<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cable Spectrogram Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body { margin:0; padding:0; font-family: Arial, sans-serif; }
  #map { height: 70vh; width: 100%; margin-bottom: 20px; }
  #spectrogram { display: block; margin: auto; max-height: 30vh; border: 1px solid #ccc; }
  .header { text-align:center; margin: 20px; }
</style>
</head>
<body>

<div class="header">
  <h1>Pintail Cable Map with Spectrograms</h1>
  <p>Click along the cable to view spectrograms</p>
</div>

<div id="map"></div>
<img id="spectrogram" src="" alt="Click on cable to see spectrogram" />
<div id="spec-title" style="text-align:center; margin:10px;"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
var map = L.map('map').setView([47.6, -122.3], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// --- Load spectrogram paths from spectrogram_index.txt ---
var spectrograms = [];
fetch('spectrogram_index.txt')
  .then(resp => resp.text())
  .then(text => {
    spectrograms = text.split(/\r?\n/).filter(line => line.trim() !== '');
  });

// --- Cable layout with gentle bend at ~600m ---
var cable = [
  [48.558194, -123.173432],
  [48.556614, -123.17767],
  [48.557296, -123.181350], // bend
  [48.555251, -123.181608],
  [48.547978, -123.183517]
];
var cableLine = L.polyline(cable, {color:'blue', weight:3}).addTo(map);
map.fitBounds(cableLine.getBounds());

// --- Click on cable to view spectrogram ---
cableLine.on('click', function(e){
  if(spectrograms.length === 0) return;
  var nearestIndex = 0;
  var minDist = Infinity;
  cable.forEach(function(latlng, i){
    var d = map.distance(latlng, e.latlng);
    if(d < minDist){ minDist=d; nearestIndex=i; }
  });
  document.getElementById('spectrogram').src = spectrograms[nearestIndex % spectrograms.length];
  document.getElementById('spec-title').textContent = `Channel ${nearestIndex}`;
});

// --- Function to parse coordinates from HTML track files ---
function parseTrackHTML(htmlText){
  // Assumes coordinates are in L.polyline([...]) in the HTML files
  var matches = htmlText.match(/\[\s*[\d\.\-]+,\s*[\d\.\-]+\s*\]/g);
  return matches.map(function(s){
    var nums = s.replace(/\[|\]/g,'').split(',').map(Number);
    return [nums[0], nums[1]];
  });
}

// --- Load Pintail boat tracks ---
fetch('pintail_boat_track.html')
  .then(resp => resp.text())
  .then(html => {
    var coords = parseTrackHTML(html);
    if(coords.length) L.polyline(coords, {color:'green', weight:3}).addTo(map);
  });

// --- Load Pintail waypoints ---
fetch('pintail_waypoints_track.html')
  .then(resp => resp.text())
  .then(html => {
    var coords = parseTrackHTML(html);
    coords.forEach(latlng => {
      L.circleMarker(latlng, {color:'red', radius:4}).addTo(map);
    });
  });

</script>
</body>
</html>
